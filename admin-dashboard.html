<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - Elite Fitness</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #ff6b6b;
            --success: #4ecdc4;
            --warning: #ffe66d;
            --text: #ffffff;
            --text-muted: #a0a0a0;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(78, 205, 196, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(255, 107, 107, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .table-row {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .table-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .badge-warning {
            background: rgba(255, 230, 109, 0.2);
            color: #ffe66d;
        }

        .badge-danger {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center px-4">
        <div class="glass-card w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-8">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <form onsubmit="adminLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-3 text-white"
                           placeholder="admin@example.com">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" required
                           class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-3 text-white"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn-primary w-full">
                    –í–æ–π—Ç–∏
                </button>
                <div id="loginError" class="mt-4 text-red-400 text-center text-sm"></div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="py-6 px-4 border-b border-white border-opacity-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                    <p class="text-gray-300 text-sm mt-1">Elite Fitness Dashboard</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-300" id="adminName">–ê–¥–º–∏–Ω</span>
                    <button onclick="logout()" class="btn-primary">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </header>

        <!-- Stats Overview -->
        <section class="py-8 px-4">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Total Users -->
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300 text-sm">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                            <span class="text-2xl">üë•</span>
                        </div>
                        <div class="text-3xl font-bold" id="totalUsers">0</div>
                        <div class="text-xs text-gray-400 mt-2">+<span id="newUsersToday">0</span> —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>

                    <!-- Total Workouts -->
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300 text-sm">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span>
                            <span class="text-2xl">üí™</span>
                        </div>
                        <div class="text-3xl font-bold" id="totalWorkouts">0</div>
                        <div class="text-xs text-gray-400 mt-2">+<span id="workoutsToday">0</span> —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>

                    <!-- Active Users -->
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300 text-sm">–ê–∫—Ç–∏–≤–Ω—ã–µ (7 –¥–Ω–µ–π)</span>
                            <span class="text-2xl">üî•</span>
                        </div>
                        <div class="text-3xl font-bold" id="activeUsers">0</div>
                        <div class="text-xs text-gray-400 mt-2"><span id="activePercent">0</span>% –æ—Ç –≤—Å–µ—Ö</div>
                    </div>

                    <!-- Avg Workouts -->
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300 text-sm">–°—Ä–µ–¥–Ω–µ–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span>
                            <span class="text-2xl">üìä</span>
                        </div>
                        <div class="text-3xl font-bold" id="avgWorkouts">0</div>
                        <div class="text-xs text-gray-400 mt-2">–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts -->
        <section class="py-8 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- User Growth Chart -->
                    <div class="glass-card">
                        <h3 class="text-xl font-bold mb-4">–†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div id="userGrowthChart" style="width:100%; height:300px;"></div>
                    </div>

                    <!-- Workout Activity Chart -->
                    <div class="glass-card">
                        <h3 class="text-xl font-bold mb-4">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                        <div id="workoutActivityChart" style="width:100%; height:300px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Table -->
        <section class="py-8 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="glass-card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                        <input type="text" id="searchUsers" placeholder="–ü–æ–∏—Å–∫..."
                               class="bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-2 text-white">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-gray-300 text-sm border-b border-white border-opacity-20">
                                    <th class="pb-3 px-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                    <th class="pb-3 px-4">Email</th>
                                    <th class="pb-3 px-4">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</th>
                                    <th class="pb-3 px-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                                    <th class="pb-3 px-4">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="pb-3 px-4">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Email Campaign -->
        <section class="py-8 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="glass-card">
                    <h2 class="text-2xl font-bold mb-6">Email-—Ä–∞—Å—Å—ã–ª–∫–∞</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">–¢–µ–º–∞ –ø–∏—Å—å–º–∞</label>
                            <input type="text" id="emailSubject"
                                   class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-2 text-white"
                                   placeholder="–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ!">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞</label>
                            <textarea id="emailBody" rows="6"
                                      class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-2 text-white"
                                      placeholder="–ü—Ä–∏–≤–µ—Ç! –ü–æ—Ä–∞ —Ä–∞–∑–º—è—Ç—å—Å—è..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</label>
                            <select id="emailRecipients"
                                    class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-2 text-white">
                                <option value="all">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                                <option value="active">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–º</option>
                                <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–º (7+ –¥–Ω–µ–π)</option>
                            </select>
                        </div>

                        <button onclick="sendEmailCampaign()" class="btn-primary">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É üìß
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Push Notifications -->
        <section class="py-8 px-4">
            <div class="max-w-7xl mx-auto">
                <div class="glass-card">
                    <h2 class="text-2xl font-bold mb-6">Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                            <input type="text" id="pushTitle"
                                   class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-2 text-white"
                                   placeholder="Elite Fitness">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                            <textarea id="pushBody" rows="3"
                                      class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg px-4 py-2 text-white"
                                      placeholder="–ü–æ—Ä–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è!"></textarea>
                        </div>

                        <button onclick="sendPushNotification()" class="btn-primary">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ üîî
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase Config & Service -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-service.js"></script>

    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // ============================================
        // EmailJS Configuration
        // ============================================
        const EMAILJS_PUBLIC_KEY = "2Q9wTW08Fnqha_Z35";
        const EMAILJS_SERVICE_ID = "service_brzpmyu";
        const EMAILJS_TEMPLATE_ID = "template_ic1z0uf";

        // Initialize EmailJS
        emailjs.init(EMAILJS_PUBLIC_KEY);

        let allUsers = [];
        let allWorkouts = [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        firebaseAuth.onAuthStateChanged(async (user) => {
            if (!user) {
                // –ù–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
                return;
            }

            // –ó–∞–ª–æ–≥–∏–Ω–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω–∫—É
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');

            const userDataResult = await getUserData(user.uid);
            document.getElementById('adminName').textContent = userDataResult.success ? userDataResult.data.fullName : '–ê–¥–º–∏–Ω';

            await loadDashboardData();
        });

        // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
        async function adminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            errorDiv.textContent = '–í—Ö–æ–¥...';

            try {
                await firebaseAuth.signInWithEmailAndPassword(email, password);
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ onAuthStateChanged –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç –∞–¥–º–∏–Ω–∫—É
                errorDiv.textContent = '';
            } catch (error) {
                errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                console.error('Login error:', error);
            }
        }

        async function loadDashboardData() {
            try {
                // Get all users
                const usersResult = await getAllUsers();
                if (usersResult.success) {
                    allUsers = usersResult.data;
                }

                // Get all workouts
                const querySnapshot = await firebaseDB.collection('workouts').get();
                allWorkouts = [];
                querySnapshot.forEach((doc) => {
                    allWorkouts.push({ id: doc.id, ...doc.data() });
                });

                // Update stats
                updateStats();
                updateCharts();
                updateUsersTable();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateStats() {
            const totalUsers = allUsers.length;
            const totalWorkouts = allWorkouts.length;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const newUsersToday = allUsers.filter(u => {
                if (!u.createdAt) return false;
                const created = u.createdAt.toDate ? u.createdAt.toDate() : new Date(u.createdAt);
                return created >= today;
            }).length;

            const workoutsToday = allWorkouts.filter(w => {
                if (!w.date) return false;
                const workoutDate = new Date(w.date);
                return workoutDate >= today;
            }).length;

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const activeUsers = allUsers.filter(u => {
                if (!u.lastLogin) return false;
                const lastLogin = u.lastLogin.toDate ? u.lastLogin.toDate() : new Date(u.lastLogin);
                return lastLogin >= sevenDaysAgo;
            }).length;

            const avgWorkouts = totalUsers > 0 ? (totalWorkouts / totalUsers).toFixed(1) : 0;
            const activePercent = totalUsers > 0 ? Math.round((activeUsers / totalUsers) * 100) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalWorkouts').textContent = totalWorkouts;
            document.getElementById('newUsersToday').textContent = newUsersToday;
            document.getElementById('workoutsToday').textContent = workoutsToday;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activePercent').textContent = activePercent;
            document.getElementById('avgWorkouts').textContent = avgWorkouts;
        }

        function updateCharts() {
            // User Growth Chart
            const usersByDate = {};
            allUsers.forEach(user => {
                if (!user.createdAt) return;
                const date = user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
                const dateStr = date.toISOString().split('T')[0];
                usersByDate[dateStr] = (usersByDate[dateStr] || 0) + 1;
            });

            const sortedDates = Object.keys(usersByDate).sort();
            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += usersByDate[date];
                return cumulative;
            });

            const userGrowthData = [{
                x: sortedDates,
                y: cumulativeData,
                type: 'scatter',
                mode: 'lines+markers',
                marker: { color: '#ff6b6b' },
                line: { color: '#ff6b6b', width: 3 }
            }];

            const userGrowthLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                margin: { t: 20, b: 40, l: 40, r: 20 }
            };

            Plotly.newPlot('userGrowthChart', userGrowthData, userGrowthLayout, { responsive: true });

            // Workout Activity Chart
            const workoutsByDate = {};
            allWorkouts.forEach(workout => {
                if (!workout.date) return;
                const date = new Date(workout.date);
                const dateStr = date.toISOString().split('T')[0];
                workoutsByDate[dateStr] = (workoutsByDate[dateStr] || 0) + 1;
            });

            const workoutDates = Object.keys(workoutsByDate).sort().slice(-14);
            const workoutCounts = workoutDates.map(date => workoutsByDate[date]);

            const workoutActivityData = [{
                x: workoutDates,
                y: workoutCounts,
                type: 'bar',
                marker: { color: '#4ecdc4' }
            }];

            const workoutActivityLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                margin: { t: 20, b: 40, l: 40, r: 20 }
            };

            Plotly.newPlot('workoutActivityChart', workoutActivityData, workoutActivityLayout, { responsive: true });
        }

        function updateUsersTable(searchTerm = '') {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            const filteredUsers = allUsers.filter(user => {
                if (!searchTerm) return true;
                const search = searchTerm.toLowerCase();
                return (user.fullName || '').toLowerCase().includes(search) ||
                       (user.email || '').toLowerCase().includes(search);
            });

            filteredUsers.forEach(user => {
                const userWorkouts = allWorkouts.filter(w => w.userId === user.id).length;

                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                let status = 'inactive';
                if (user.lastLogin) {
                    const lastLogin = user.lastLogin.toDate ? user.lastLogin.toDate() : new Date(user.lastLogin);
                    status = lastLogin >= sevenDaysAgo ? 'active' : 'inactive';
                }

                const regDate = user.createdAt ?
                    (user.createdAt.toDate ? user.createdAt.toDate() : new Date(user.createdAt)).toLocaleDateString('ru-RU') :
                    '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="py-3 px-4">${user.fullName || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
                    <td class="py-3 px-4">${user.email || '–ù–µ—Ç email'}</td>
                    <td class="py-3 px-4">${userWorkouts}</td>
                    <td class="py-3 px-4 text-sm text-gray-400">${regDate}</td>
                    <td class="py-3 px-4">
                        <span class="badge ${status === 'active' ? 'badge-success' : 'badge-warning'}">
                            ${status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <button onclick="viewUserDetails('${user.id}')"
                                class="text-blue-400 hover:text-blue-300 text-sm">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            const userWorkouts = allWorkouts.filter(w => w.userId === userId);

            alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.fullName}\nEmail: ${user.email}\n–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: ${userWorkouts.length}`);
        }

        async function sendEmailCampaign() {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const recipients = document.getElementById('emailRecipients').value;

            if (!subject || !body) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–º—É –∏ —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É EmailJS
            if (EMAILJS_PUBLIC_KEY === "YOUR_EMAILJS_PUBLIC_KEY" ||
                EMAILJS_SERVICE_ID === "YOUR_SERVICE_ID" ||
                EMAILJS_TEMPLATE_ID === "YOUR_TEMPLATE_ID") {
                alert('‚ö†Ô∏è EmailJS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\n\n–û—Ç–∫—Ä–æ–π EMAILJS_SETUP.md –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.\n\n–¢–µ–±–µ –Ω—É–∂–Ω–æ:\n1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ emailjs.com\n2. –ü–æ–ª—É—á–∏—Ç—å Public Key, Service ID –∏ Template ID\n3. –í—Å—Ç–∞–≤–∏—Ç—å –∏—Ö –≤ –∫–æ–¥ admin-dashboard.html');
                return;
            }

            let targetUsers = allUsers;

            if (recipients === 'active') {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                targetUsers = allUsers.filter(u => {
                    if (!u.lastLogin) return false;
                    const lastLogin = u.lastLogin.toDate ? u.lastLogin.toDate() : new Date(u.lastLogin);
                    return lastLogin >= sevenDaysAgo;
                });
            } else if (recipients === 'inactive') {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                targetUsers = allUsers.filter(u => {
                    if (!u.lastLogin) return true;
                    const lastLogin = u.lastLogin.toDate ? u.lastLogin.toDate() : new Date(u.lastLogin);
                    return lastLogin < sevenDaysAgo;
                });
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å email
            targetUsers = targetUsers.filter(u => u.email && u.email.includes('@'));

            if (targetUsers.length === 0) {
                alert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                return;
            }

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ ${targetUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            let sent = 0;
            let failed = 0;
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:white; padding:30px; border-radius:15px; z-index:10000; text-align:center;';
            progressDiv.innerHTML = `
                <h3 style="margin-bottom:15px;">üìß –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º...</h3>
                <div id="emailProgress">0 / ${targetUsers.length}</div>
                <div style="margin-top:10px; color:#4ecdc4;" id="emailStatus">–ì–æ—Ç–æ–≤–∏–º—Å—è...</div>
            `;
            document.body.appendChild(progressDiv);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∏—Å—å–º–∞ –ø–æ –æ–¥–Ω–æ–º—É —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã)
            for (let i = 0; i < targetUsers.length; i++) {
                const user = targetUsers[i];

                document.getElementById('emailStatus').textContent = `–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ ${user.email}...`;

                try {
                    await emailjs.send(
                        EMAILJS_SERVICE_ID,
                        EMAILJS_TEMPLATE_ID,
                        {
                            to_email: user.email,
                            to_name: user.fullName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                            from_name: 'Elite Fitness',
                            subject: subject,
                            message: body,
                            reply_to: 'noreply@elitefitness.com'
                        }
                    );
                    sent++;
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ ${user.email}:`, error);
                    console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.text);
                    failed++;
                }

                document.getElementById('emailProgress').textContent = `${sent + failed} / ${targetUsers.length}`;

                // –ü–∞—É–∑–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã EmailJS)
                if (i < targetUsers.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            progressDiv.innerHTML = `
                <h3 style="color:#4ecdc4; margin-bottom:15px;">‚úÖ –ì–æ—Ç–æ–≤–æ!</h3>
                <div>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sent}</div>
                <div style="color:#ff6b6b;">–û—à–∏–±–æ–∫: ${failed}</div>
                <button onclick="this.parentElement.remove()"
                        style="margin-top:20px; background:linear-gradient(135deg, #ff6b6b, #4ecdc4); border:none; color:white; padding:10px 30px; border-radius:10px; cursor:pointer;">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            `;
        }

        async function sendPushNotification() {
            const title = document.getElementById('pushTitle').value;
            const body = document.getElementById('pushBody').value;

            if (!title || !body) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }

            alert(`Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...\n\n–í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Firebase Cloud Messaging.`);
            // TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FCM
        }

        async function logout() {
            await logoutUser();
            window.location.href = 'register.html';
        }

        // Search functionality
        document.getElementById('searchUsers').addEventListener('input', (e) => {
            updateUsersTable(e.target.value);
        });
    </script>
</body>
</html>